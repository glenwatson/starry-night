<html>
	<head>
		<style>
			body {
				margin: 0;
				width: 100%;
				height: 100%;
			}
		</style>
	</head>
	<body>
		<canvas id="space">No canvas support</canvas>
		<script>
			var SPEED = 10;
			var NUM_STARS = 1000;
			var FORCE_DIST = 200;
			var DRAW_FORCES = true;
			var DRAW_BG = true;
			var canvas = document.getElementById('space');
			canvas.width = document.body.clientWidth;
			canvas.height = document.body.clientHeight;
			var ctx = canvas.getContext('2d');
			
			var stars = [];
			var forces = [];
			//populate
			for(var i=0; i<NUM_STARS; i++) {
				stars.push({
					pos: {
						x: Math.random() * canvas.width,
						y: Math.random() * canvas.height,
					},
					color: randomColor()
				});
			}
			/*
			forces.push({pos: {x: 300, y: 300}, vect: {x: 0, y: 10}, strength: 10});
			forces.push({pos: {x: 300, y: 300}, vect: {x: 10, y: 0}, strength: 10});
			forces.push({pos: {x: 300, y: 300}, vect: {x: 0, y: -10}, strength: 10});
			forces.push({pos: {x: 300, y: 300}, vect: {x: -10, y: 0}, strength: 10});
			forces.push({pos: {x: 700, y: 700}, vect: {x: 0, y: 5}, strength: 10});
			forces.push({pos: {x: 1200, y: 300}, vect: {x: 5, y: 5}, strength: 10});
			forces.push({pos: {x: 1200, y: 300}, vect: {x: 5, y: 5}, strength: 10});
			*/
			forces.push({pos: {x: 900, y: 300}, vect: {x: 0, y: 500}, strength: 1});
			forces.push({pos: {x: 800, y: 200}, vect: {x: 500, y: 0}, strength: 1});
			forces.push({pos: {x: 700, y: 300}, vect: {x: 0, y: -500}, strength: 1});
			forces.push({pos: {x: 800, y: 400}, vect: {x: -500, y: 0}, strength: 1});
			
			//start
			if (!DRAW_BG) {
				drawBG();
			}
			setInterval(tick, SPEED);
			function tick() {
				console.log('tick');
				moveStars(stars);
				if (DRAW_BG) {
					drawBG();
				}
				drawStars(stars);
				if (DRAW_FORCES) {
					drawForces(forces);
				}
			}
			function dist(pos1, pos2) {
				return Math.sqrt(Math.pow(pos1.x - pos2.x, 2) + Math.pow(pos1.y - pos2.y, 2));
			}
			function drawStars(stars) {
				for(var i in stars) {
					ctx.fillStyle = stars[i].color;
					drawStar(stars[i].pos.x, stars[i].pos.y, ctx);
				}
			}
			function drawStar(x, y, ctx) {
				ctx.beginPath();
				ctx.arc(x, y, 2, 0, Math.PI*2, true);
				ctx.fill();
				ctx.closePath();
			}
			function drawForces(forces) {
				ctx.strokeStyle = "#ffffff";
				for(var i in forces) {
					drawForce(forces[i], ctx);
				}
			}
			function drawForce(force, ctx) {
				ctx.lineWidth = force.strength/5;
				ctx.beginPath();
				ctx.moveTo(force.pos.x, force.pos.y);
				ctx.lineTo(force.pos.x+force.vect.x, force.pos.y+force.vect.y);
				ctx.stroke();
				ctx.beginPath();
				ctx.arc(force.pos.x+force.vect.x, force.pos.y+force.vect.y, force.strength*2, 0, Math.PI*2, true);
				ctx.stroke();
			}
			function drawBG () {
				ctx.fillStyle = "#000000";
				ctx.fillRect(0, 0, canvas.width, canvas.height);
			}
			function randomColor() {
				return "#"+randomHex()+randomHex()+randomHex()+randomHex()+randomHex()+randomHex();
			}
			function randomHex() {
				return Math.round(Math.random() * 16).toString(16);
			}
			// ==Movement==
			function moveStars(stars) {
					for (var f in forces) {
					var force = forces[f];
					var forceEnd = add(force.pos, force.vect);
					for(var i in stars) {
						var star = stars[i];
						var d = distPointToSegment(star.pos, force.pos, forceEnd);
						if (d < FORCE_DIST) {
							var pull = force.strength * (FORCE_DIST - d) / FORCE_DIST;
							if (force.vect.x) {
								star.pos.x += pull * force.vect.x / Math.abs(force.vect.x);
							}
							if (force.vect.y) {
								star.pos.y += pull * force.vect.y / Math.abs(force.vect.y);
							}
						}
					}
				}
			}
			function distPointToSegment(point, segStart, segEnd) {
				var v = sub(segEnd, segStart);
				var w = sub(point, segStart);
				var c1 = dot(w,v);
				if (c1 <= 0) {
					return vDist(point, segStart);
				}
				var c2 = dot(v,v);
				if (c2 <= c1) {
					return vDist(point, segEnd);
				}
				var b = c1 / c2;
				var pointB = add(segStart, vMulScalar(b, v));
				return vDist(point, pointB);
			}
			// =Helper functions=
			function dot(a, b) {
				return a.x * b.x + a.y * b.y;
			}
			function norm(v) {
				return Math.sqrt(dot(v,v));
			}
			function vDist(p1, p2) {
				return norm(sub(p1, p2));
			}
			function add(a, b) {
				return {x: a.x + b.x, y: a.y + b.y};
			}
			function sub(a, b) {
				return {x: a.x - b.x, y: a.y - b.y};
			}
			function vMulScalar(s, v) {
				return {x: v.x * s, y: v.y * s};
			}
		</script>
	</body>
</html>
